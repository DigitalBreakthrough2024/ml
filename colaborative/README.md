README

# Рекомендательная система на основе ALS

Этот проект реализует рекомендательную систему на основе алгоритма чередующегося наименьшего квадрата (ALS) с использованием библиотеки `implicit` для коллаборативной фильтрации. Система обрабатывает большие наборы данных взаимодействий пользователей (логи) и метаданные видео, обучая модель рекомендаций с использованием пакетной обработки для решения проблем с памятью.

---

## Описание проекта

Проект включает:
1. **Пакетная обработка данных**: Логи обрабатываются частями для оптимизации использования памяти.
2. **Обучение модели ALS**: Модель использует алгоритм ALS для вычисления скрытых факторов для пользователей и видео и генерирует рекомендации.
3. **Обработка больших наборов данных**: Данные хранятся в формате `.parquet`, а загрузка данных происходит пакетами для предотвращения переполнения памяти.

---

## Основные функции

1. **Пакетная загрузка и обработка данных**: Система обрабатывает данные пакетами из файлов Parquet, что позволяет эффективно работать с большими наборами данных.
2. **Модель ALS**: Используется коллаборативная фильтрация с алгоритмом чередующегося наименьшего квадрата (ALS) для генерации рекомендаций.
3. **Инкрементальные обновления**: Система поддерживает добавление новых пользователей и видео динамически без необходимости полного переобучения модели.
4. **Расчёт точности**: Функция для вычисления точности рекомендаций на основе обратной связи пользователя за несколько итераций.

---

## Требования

Проект требует установки следующих библиотек Python:
- `pandas`: для работы с данными.
- `numpy`: для эффективных числовых операций.
- `scipy.sparse`: для работы с разреженными матрицами.
- `implicit`: для реализации алгоритма ALS.
- `joblib`: для сериализации моделей (сохранение и загрузка).
- `pyarrow`: для работы с файлами формата `.parquet`.

---

## Файлы

- **`run_recommendation_system_batch`**: Функция для пакетной обработки логов и обучения модели ALS.
- **`generate_recommendations`**: Функция для генерации рекомендаций для пользователя на основе обученной модели.
- **`presicion_colab`**: Функция для расчёта точности рекомендаций на основе обратной связи пользователя.
- **`load_model_and_indices`**: Загружает обученную модель и индексы пользователей и видео с диска.
- **`create_interaction_matrix_in_batches`**: Создаёт матрицу взаимодействий на основе пакетов данных.
- **`preprocess_logs_batch`**: Предобрабатывает каждый пакет логов, рассчитывая неявные оценки взаимодействий.

---

## Использование

### 1. Установка зависимостей
Убедитесь, что все необходимые библиотеки установлены:
```bash
pip install pandas numpy scipy implicit joblib pyarrow
```

### 2. Обучение модели

Система поддерживает инкрементальные обновления и обучение модели ALS с использованием пакетных данных. Используйте функцию `run_recommendation_system_batch()` для обучения модели на больших наборах данных.

Пример использования системы рекомендаций в Colab:

```python
logs_path = '/content/drive/MyDrive/logs.parquet'
video_data_path = '/content/drive/MyDrive/video_stat.parquet'
model_filepath = 'als_model.pkl'
batch_size = 100000

# Загрузка модели и индексов или обучение новой модели
load_model_and_indices(model_filepath)

# Пример входных данных для системы рекомендаций
initial_ratings = {
    "video_id_1": "like",
    "video_id_2": "dislike",
    "video_id_3": "neutral",
}
watched_videos = ["video_id_1", "video_id_5"] + list(initial_ratings.keys())
current_user_id = "USER_HASH"

# Получение рекомендаций
recommendations = run_recommendation_system(initial_ratings, watched_videos, current_user_id)
print("Рекомендованные видео:", recommendations)
```

### 3. Оценка рекомендаций

Система позволяет оценивать качество рекомендаций с использованием расчёта точности за несколько циклов рекомендаций:

```python
ratings = {'like': 0, 'dislike': 0, 'neutral': 0}

for _ in range(15):
    # Симуляция оценок пользователя для новой подборки
    initial_ratings = dict(zip(recommendations, random.choices(list(ratings.keys()), weights=[4, 1, 2], k=10)))
    watched_videos += list(initial_ratings.keys())

    # Обновление статистики оценок
    for key in ratings:
        ratings[key] += list(initial_ratings.values()).count(key)

    # Генерация новых рекомендаций
    recommendations = run_recommendation_system(initial_ratings, watched_videos, current_user_id)

# Расчёт точности
precision = presicion_colab(ratings)
print(f"Точность: {precision}")
```

---

## Описание функций

- **`load_model_and_indices(model_filepath)`**: Загружает модель и связанные с ней файлы индексов (`user_id_to_index.pkl`, `video_id_to_index.pkl`). Если модель не найдена, она обрабатывает данные пакетами и обучает новую модель.

- **`create_interaction_matrix_in_batches(parquet_path, video_data, batch_size)`**: Загружает логи из файла `.parquet` пакетами, предобрабатывает каждый пакет и строит разреженную матрицу взаимодействий для обучения модели ALS.

- **`preprocess_logs_batch(logs_batch, video_data, video_id_to_index)`**: Объединяет логи с метаданными видео, рассчитывает неявные оценки взаимодействий и обновляет индексы элементов для каждого пакета данных.

- **`generate_recommendations(model, video_id_to_index, current_user_index, watched_videos)`**: Генерирует топ-10 видео для рекомендаций пользователю на основе его истории взаимодействий.

---

## Заключение

Система предназначена для работы с большими наборами данных, эффективно обрабатывая их пакетами и оптимизируя использование памяти. Она использует коллаборативную фильтрацию и поддерживает динамическое обновление моделей без необходимости полного переобучения.
```
